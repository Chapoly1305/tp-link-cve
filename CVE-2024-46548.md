# CVE-2024-46548

TP-Link Tapo P125M version 1.0.2 and Kasa KP125M version 1.0.3 do not properly validate certificates, which may allow a remote unauthenticated attacker to eavesdrop on an encrypted communication via a man-in-the-middle attack, extract account credentials, and device configuration, intercept the conversation, and unbind the device from an existing account.

**Keywords:** Man-in-the-middle, Information Disclosure, Command Injection

## Description
Affected devices utilize MQTT interactive with a remote server for status reports and user remote control. Since the affected devices do not validate the remote server's certificate, an attacker may intercept the traffic, perform injection, take control of the affected device, and acquire device status.

The unbind and bind commands allow an attacker to intercept the credentials to log in to TP-Link web services, expanding the affected scope.

## Replication Steps
1. Set up a network with DNS redirection to a PC acting as a proxy.
2. Use tools like [tcpproxy](https://github.com/ickerwx/tcpproxy) for TLS proxying and Wireshark for traffic analysis.
3. Capture and decrypt MQTT traffic between the device and TP-Link servers.
4. Extract MQTT login credentials and device information from the decrypted traffic.
5. Inject malicious MQTT messages to control or unbind the device from the user account. Await the user to bind the device and extract the account credentials.

## Analysis
**CVSS:3.0 8.8 High**

Vector: AV:N/AC:L/PR:N/UI:R/S:C/C:H/I:H/A:H

- AV: Network. The attacker can exploit this vulnerability in any node between a device and TP-Link Cloud service, e.g., ISP, IDC.
- PR: None. An attacker can exploit TP-Link products without having permission from any user or administrator.
- S: Changed. Attackers may inject messages and affect the display of information on the mobile app. They may also use the extracted account credential log on the TP-Link website and forms. The attacker may retrieve, alter, or delete information from the account. The attacker may also log in to other TP-Link products via the mobile companion app, e.g., the home camera.
AC: Low. The attack can be easily replicated and automated, and this issue can be reproduced consistently.
CIA: High. Information about the device can be revealed and altered. An attacker may make a device inaccessible by sending an unpair instruction; the device itself is not damaged. Attackers may eavesdrop on TP-Link credentials from a newly paired device or purposely unpair an existing device, forcing the user to pair and causing credentials to be eavesdropped from the traffic. Once the account password is acquired, user personal information can be retrieved, altered, and deleted.

## History
- June 2024: Reported to TP-Link.
- June 2024: Vendor confirmed the issue.
- August 2024: Confirmed mitigated on vendor-provided firmware.
